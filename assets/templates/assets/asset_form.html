{% extends "base.html" %}
{% load static %}

{% block title %}{% if asset %}Edit Asset{% else %}Create Asset{% endif %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
<style>
    body {
        background-color: #f8f9fa;
    }
    .container {
        max-width: 800px;
        margin-top: 30px;
    }
    .card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .card-header {
        background-color: #343a40;
        color: white;
        font-weight: bold;
        text-align: center;
        font-size: 1.25rem;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    .form-control, 
    .select2-container--bootstrap4 .select2-selection,
    .flatpickr-input {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.5rem 0.75rem;
        height: calc(1.5em + 1rem + 2px);
        width: 100%;
        font-size: 1rem;
        line-height: 1.5;
        background-color: #ffffff;
    }
    .input-group .form-control {
        width: 100%;
    }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow {
        top: 8px;
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    .btn-primary:hover, .btn-primary:focus {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .modal-header {
        background-color: #343a40;
        color: white;
    }
    .modal-title {
        font-weight: bold;
    }
    .input-group-append .btn {
        height: calc(1.5em + 1rem + 2px);
        padding: 0.5rem 0.75rem;
    }
    .flatpickr-input[readonly] {
        background-color: #fff;
    }
    .form-check-input {
        margin-top: 0.3rem;
    }
    .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    .btn-outline-secondary {
        border-color: #007bff;
        color: #007bff;
    }
    .btn-outline-secondary:hover, .btn-outline-secondary:focus {
        background-color: #007bff;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h2 class="mb-0">{% if asset %}Edit Asset{% else %}Create Asset{% endif %}</h2>
        </div>
        <div class="card-body">
            <form method="post" id="assetForm">
                {% csrf_token %}
                {{ form.non_field_errors }}
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form.asset_type.errors }}
                        <label for="{{ form.asset_type.id_for_label }}">Asset Type:</label>
                        <div class="input-group">
                            {{ form.asset_type }}
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#assetTypeModal">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.asset_number.errors }}
                        <label for="{{ form.asset_number.id_for_label }}">Asset Number:</label>
                        {{ form.asset_number }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form.location.errors }}
                        <label for="{{ form.location.id_for_label }}">Location:</label>
                        <div class="input-group">
                            {{ form.location }}
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#locationModal">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.room_number.errors }}
                        <label for="{{ form.room_number.id_for_label }}">Room Number:</label>
                        <div class="input-group">
                            {{ form.room_number }}
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#roomNumberModal">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form.department.errors }}
                        <label for="{{ form.department.id_for_label }}">Department:</label>
                        <div class="input-group">
                            {{ form.department }}
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#departmentModal">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.purchase_date.errors }}
                        <label for="{{ form.purchase_date.id_for_label }}">Purchase Date:</label>
                        {{ form.purchase_date }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form.purchase_value.errors }}
                        <label for="{{ form.purchase_value.id_for_label }}">Purchase Value:</label>
                        {{ form.purchase_value }}
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.assigned_to.errors }}
                        <label for="{{ form.assigned_to.id_for_label }}">Assigned To:</label>
                        {{ form.assigned_to }}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        <div class="form-check">
                            {{ form.sticker_deployed }}
                            <label class="form-check-label" for="{{ form.sticker_deployed.id_for_label }}">
                                Sticker Deployed
                            </label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>
</div>

<!-- Asset Type Modal -->
<div class="modal fade" id="assetTypeModal" tabindex="-1" role="dialog" aria-labelledby="assetTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assetTypeModalLabel">Add Asset Type</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="assetTypeForm">
                    {% csrf_token %}
                    {{ asset_type_form.as_p }}
                    <div id="assetTypeError" class="error-message"></div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" role="dialog" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalLabel">Add Location</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="locationForm">
                    {% csrf_token %}
                    {{ location_form.as_p }}
                    <div id="locationError" class="error-message"></div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Room Number Modal -->
<div class="modal fade" id="roomNumberModal" tabindex="-1" role="dialog" aria-labelledby="roomNumberModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roomNumberModalLabel">Add Room Number</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="roomNumberForm">
                    {% csrf_token %}
                    {{ room_number_form.as_p }}
                    <div id="roomNumberError" class="error-message"></div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Department Modal -->
<div class="modal fade" id="departmentModal" tabindex="-1" role="dialog" aria-labelledby="departmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="departmentModalLabel">Add Department</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    {% csrf_token %}
                    {{ department_form.as_p }}
                    <div id="departmentError" class="error-message"></div>
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('.select2').select2({
        theme: 'bootstrap4',
    });

    flatpickr('#{{ form.purchase_date.id_for_label }}', {
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            var purchaseDate = new Date(dateStr);
            var depreciationDate = new Date(purchaseDate.setFullYear(purchaseDate.getFullYear() + 5));
            $('#depreciation_date').val(depreciationDate.toISOString().split('T')[0]);
        }
    });

    $('#{{ form.assigned_to.id_for_label }}').select2({
        theme: 'bootstrap4',
        ajax: {
            url: '{% url "get_users" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term,
                    page: params.page
                };
            },
            processResults: function (data, params) {
                params.page = params.page || 1;
                return {
                    results: data.results,
                    pagination: {
                        more: (params.page * 30) < data.total_count
                    }
                };
            },
            cache: true
        },
        minimumInputLength: 1
    });

    function handleFormSubmission(formId, url, fieldId, errorDivId) {
        $(formId).on('submit', function(e) {
            e.preventDefault();
            $.ajax({
                url: url,
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    console.log('Success:', response);
                    var newOption = new Option(response.name, response.id, true, true);
                    $(fieldId).append(newOption).trigger('change');
                    $(formId).closest('.modal').modal('hide');
                    $(errorDivId).text('');  // Clear any previous error messages
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseJSON);
                    var errorMessage = 'An error occurred. Please try again.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    $(errorDivId).text(errorMessage);
                }
            });
        });
    }

    handleFormSubmission('#assetTypeForm', '{% url "add_asset_type" %}', '#{{ form.asset_type.id_for_label }}', '#assetTypeError');
    handleFormSubmission('#locationForm', '{% url "add_location" %}', '#{{ form.location.id_for_label }}', '#locationError');
    handleFormSubmission('#roomNumberForm', '{% url "add_room_number" %}', '#{{ form.room_number.id_for_label }}', '#roomNumberError');
    handleFormSubmission('#departmentForm', '{% url "add_department" %}', '#{{ form.department.id_for_label }}', '#departmentError');
});
</script>
{% endblock %}
